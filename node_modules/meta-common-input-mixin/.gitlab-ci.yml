stages:
  - sonar
  - build
  - deploy

sonar:
  stage: sonar
  tags:
    - sonar
  script:       
    - echo executing sonar...        
    - sonar-scanner -Dsonar.projectKey=%CI_PROJECT_NAME% -Dsonar.sources=.
  only:
    - master
    
sonarqube_preview:
  stage: sonar
  tags:
    - sonar
  script:
    - echo executing sonar...   
    - git checkout origin/master
    - git merge %CI_COMMIT_SHA% --no-commit --no-ff      
    - sonar-scanner -Dsonar.projectKey=%CI_PROJECT_NAME% -Dsonar.sources=. -Dsonar.gitlab.project_id=%CI_PROJECT_ID% -Dsonar.gitlab.commit_sha=%CI_COMMIT_SHA% -Dsonar.gitlab.ref_name=%CI_COMMIT_REF_NAME% -Dsonar.analysis.mode="preview"
  except:
    - desenvolvimento
    - master
    - /^hotfix_.*$/
    - /.*-hotfix$/

build:yarn:
  stage: build
  image: node:alpine
  script:
    - yarn
    - yarn build
  cache:
    paths:
      - node_modules/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - master
  tags:
    - yarn
    - deploy
    - docker

deploy:registry:
  stage: deploy
  image: node:alpine
  script:
    - echo $NPMJS_REGISTRY_TOKEN > .npmrc
    - npm publish 
  cache:
    paths:
      - node_modules/
    policy: pull
  dependencies:
    - build:yarn
  only:
    - master
  tags:
    - yarn
    - deploy
    - docker